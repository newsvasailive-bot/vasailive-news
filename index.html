<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vasai Live News</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, deleteDoc, updateDoc, onSnapshot, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC9tqZWhUN_cCdps9e81lsOezoqEZL2XJA",
  authDomain: "vasailive-news.firebaseapp.com",
  databaseURL: "https://vasailive-news-default-rtdb.firebaseio.com",
  projectId: "vasailive-news",
  storageBucket: "vasailive-news.appspot.com",
  messagingSenderId: "527720941491",
  appId: "1:527720941491:web:9bd27e8bbc8f48b6b56dc6",
  measurementId: "G-Z85WP0D6N3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ADMIN_EMAIL = "newsvasailive@gmail.com";
const IMGBB_API_KEY = "ff902d7c63784748f5e28d5f29eef4cc";

// Elements
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const editor = document.getElementById("editor");
const postsArea = document.getElementById("postsArea");
const blocksList = document.getElementById("blocksList");
const aTitle = document.getElementById("aTitle");
const aCat = document.getElementById("aCat");
const publishBtn = document.getElementById("publishBtn");
const noticeText = document.getElementById("noticeText");
const headlineText = document.getElementById("headlineText");
const modalBg = document.getElementById("modalBg");
const modalContent = document.getElementById("modalContent");
const modalClose = document.getElementById("modalClose");
const zoomModal = document.getElementById("zoomModal");
const zoomImg = document.getElementById("zoomImg");

let editingId = null;

// AUTH
loginBtn.onclick = async () => {
  await signInWithPopup(auth, new GoogleAuthProvider());
};
logoutBtn.onclick = () => signOut(auth);

auth.onAuthStateChanged((user) => {
  if (user && user.email === ADMIN_EMAIL) {
    editor.classList.remove("hidden");
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
  } else {
    editor.classList.add("hidden");
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
  }
});

// Upload to imgbb
async function uploadToImgBB(file) {
  const formData = new FormData();
  formData.append("image", file);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
    method: "POST",
    body: formData,
  });
  const data = await res.json();
  return data.data.url;
}

// Add blocks
document.getElementById("addTextBtn").onclick = () => {
  const t = document.createElement("textarea");
  t.placeholder = "Write paragraph...";
  t.dataset.type = "text";
  t.className = "border p-2 w-full mb-2 rounded";
  blocksList.appendChild(t);
};
document.getElementById("addImageBtn").onclick = () => {
  const inp = document.createElement("input");
  inp.type = "file";
  inp.dataset.type = "image";
  inp.className = "w-full mb-2";
  blocksList.appendChild(inp);
};

// Publish / Update
publishBtn.onclick = async () => {
  const title = aTitle.value.trim();
  const cat = aCat.value.trim();
  if (!title) return alert("Enter title!");
  const blocks = [];
  for (const el of blocksList.children) {
    if (el.dataset.type === "text" && el.value.trim()) {
      blocks.push({ type: "text", text: el.value.trim() });
    } else if (el.dataset.type === "image" && el.files.length > 0) {
      const url = await uploadToImgBB(el.files[0]);
      blocks.push({ type: "image", url });
    }
  }
  if (blocks.length === 0) return alert("Add content!");
  const data = { title, category: cat, blocks, time: new Date().toLocaleString() };
  if (editingId) {
    await updateDoc(doc(db, "vasai_news", editingId), data);
    editingId = null;
  } else {
    await addDoc(collection(db, "vasai_news"), data);
  }
  aTitle.value = aCat.value = "";
  blocksList.innerHTML = "";
};

// Load posts
onSnapshot(query(collection(db, "vasai_news"), orderBy("time", "desc")), (snap) => {
  postsArea.innerHTML = "";
  const posts = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
  headlineText.textContent = posts.slice(0, 5).map((p) => p.title).join(" â€” ");
  posts.forEach((d) => {
    const img = d.blocks.find((b) => b.type === "image")?.url || "https://via.placeholder.com/300x150?text=No+Image";
    const txt = d.blocks.find((b) => b.type === "text")?.text.substring(0, 80) + "..." || "";
    const card = document.createElement("div");
    card.className = "card bg-white rounded-lg overflow-hidden shadow-md hover:shadow-xl transition";
    card.innerHTML = `<img src='${img}' class='w-full h-40 object-cover cursor-pointer'>
      <div class='p-3'><h3 class='font-bold text-lg mb-1'>${d.title}</h3><p class='text-sm text-gray-600'>${txt}</p></div>`;
    card.onclick = () => showModal(d);
    postsArea.appendChild(card);
  });
});

// Modal show
function showModal(d) {
  modalContent.innerHTML = `<h2 class='text-xl font-bold mb-2'>${d.title}</h2>`;
  d.blocks.forEach((b) => {
    if (b.type === "text")
      modalContent.innerHTML += `<p class='mb-2 text-gray-700 leading-relaxed'>${b.text}</p>`;
    else modalContent.innerHTML += `<img src='${b.url}' class='rounded-md mb-2 cursor-zoom-in'>`;
  });
  const user = auth.currentUser;
  if (user && user.email === ADMIN_EMAIL) {
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.className = "bg-yellow-500 text-white px-3 py-1 rounded mr-2";
    editBtn.onclick = () => {
      editingId = d.id;
      aTitle.value = d.title;
      aCat.value = d.category;
      blocksList.innerHTML = "";
      d.blocks.forEach((b) => {
        if (b.type === "text") {
          const t = document.createElement("textarea");
          t.value = b.text;
          t.dataset.type = "text";
          t.className = "border p-2 w-full mb-2 rounded";
          blocksList.appendChild(t);
        }
      });
      modalBg.style.display = "none";
    };
    const delBtn = document.createElement("button");
    delBtn.textContent = "Delete";
    delBtn.className = "bg-red-600 text-white px-3 py-1 rounded";
    delBtn.onclick = async () => {
      if (confirm("Delete this news?")) await deleteDoc(doc(db, "vasai_news", d.id));
      modalBg.style.display = "none";
    };
    modalContent.appendChild(editBtn);
    modalContent.appendChild(delBtn);
  }
  modalBg.style.display = "flex";
}

modalClose.onclick = () => (modalBg.style.display = "none");
modalBg.onclick = (e) => {
  if (e.target === modalBg) modalBg.style.display = "none";
};
</script>

<style>
.card img:hover { transform: scale(1.03); transition: 0.3s; }
.modal-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999; }
.modal { background:#fff; border-radius:10px; max-width:650px; width:90%; max-height:85%; overflow-y:auto; padding:16px; position:relative; }
.modal-close { position:absolute; top:10px; right:15px; cursor:pointer; }
.notice-ticker, .headline-ticker { position:sticky; overflow:hidden; white-space:nowrap; }
</style>
</head>
<body class="bg-gray-100">

<header class="flex justify-between items-center bg-blue-900 text-white p-3 sticky top-0 z-50 shadow">
  <div class="flex items-center space-x-2">
    <img src="https://i.postimg.cc/vTb8F94w/vasalive-png.jpg" class="h-10 w-10 rounded-md" alt="logo">
    <h1 class="font-bold text-lg">Vasai Live News</h1>
  </div>
  <div>
    <button id="loginBtn" class="bg-green-500 px-3 py-1 rounded">Login</button>
    <button id="logoutBtn" class="hidden bg-red-600 px-3 py-1 rounded">Logout</button>
  </div>
</header>

<div class="notice-ticker bg-red-600 text-white text-sm py-1 text-center">
  <span id="noticeText">Breaking News Updates</span>
</div>
<div class="headline-ticker bg-blue-800 text-white text-sm py-1 text-center">
  <span id="headlineText"></span>
</div>

<section id="editor" class="hidden p-3 bg-white m-3 rounded shadow">
  <h2 class="font-bold text-lg mb-2">ðŸ“° Add / Edit News</h2>
  <input id="aTitle" placeholder="Title" class="border p-2 w-full mb-2 rounded">
  <input id="aCat" placeholder="Category" class="border p-2 w-full mb-2 rounded">
  <div id="blocksList"></div>
  <button id="addTextBtn" class="bg-blue-500 text-white px-3 py-1 rounded mr-2">Add Text</button>
  <button id="addImageBtn" class="bg-purple-500 text-white px-3 py-1 rounded mr-2">Add Image</button>
  <button id="publishBtn" class="bg-green-600 text-white px-3 py-1 rounded">Publish</button>
</section>

<section id="postsArea" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 p-3"></section>

<div id="modalBg" class="modal-bg">
  <div class="modal">
    <button id="modalClose" class="modal-close bg-gray-200 px-2 rounded">X</button>
    <div id="modalContent"></div>
  </div>
</div>

<div id="zoomModal" class="modal-bg">
  <img id="zoomImg" class="max-w-full max-h-full rounded-lg shadow-lg">
</div>

</body>
</html>
